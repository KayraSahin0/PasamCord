---
alwaysApply: true
---

---
description: Comprehensive rules and architecture for the PasamCord P2P Chat Application
globs: *.js, *.html, *.css
---

# Project Name: PasamCord

**Role:** You are a Senior Full Stack Developer specialized in WebRTC, Socket.io, and Media Streaming.

**Goal:** Build a browser-based P2P Discord clone with Video/Voice chat, Screen Sharing, Ephemeral Text Chat, and a Synchronized Hybrid Music Player (YouTube & Spotify).

## 1. Tech Stack & Constraints
* **Frontend:** HTML5, CSS3 (Modern Flexbox/Grid), Vanilla JavaScript (No frameworks like React/Vue).
* **Backend:** Node.js, Express, Socket.io.
* **P2P Communication:** PeerJS (wrapping WebRTC).
* **Database:** NONE. All state (rooms, queues, chats) must be stored in server-side RAM variables.
* **Styling:** Dark Mode (Discord-like aesthetic).

## 2. Core Architecture & Logic

### A. Room System
* **ID Generation:** Rooms must use short, random 5-character alphanumeric codes (e.g., `A7X2M`).
* **Entry:** Users must provide a `username` before joining.
* **Capacity:** Strictly limited to **4 users** per room (Mesh Topology constraint).
* **Clipboard:** Clicking the Room ID in the UI must copy it to the clipboard.

### B. Communication (P2P Mesh)
* **Video/Audio:** Auto-connect to all peers upon joining.
* **Screen Sharing:** * Use `navigator.mediaDevices.getDisplayMedia`.
    * Logic: Replace the current video track of the user with the screen track for all peers.
    * Button: Toggle between Camera and Screen.
* **Mute/Deafen:** Standard controls to disable local audio/video tracks.

### C. Ephemeral Chat
* **Transport:** Use Socket.io (Reliable), NOT WebRTC Data Channels.
* **Storage:** Chat history exists only in the client's DOM and server RAM while the room is active. Destroyed on room close.

### D. Hybrid Music System (CRITICAL)
This is the most complex feature. It requires a unified server-side queue.

**Server-Side Logic (`server.js`):**
1.  **State:** Each room object must have:
    ```javascript
    queue: [], // Array of { source: 'youtube'|'spotify', id: '...', title: '...', addedBy: '...' }
    currentSong: null,
    isPlaying: false,
    startTime: 0 // For syncing seek time (optional)
    ```
2.  **Logic:**
    * **Add Song:** * If `isPlaying` is false: Set as `currentSong`, set `isPlaying=true`, broadcast `play-song`.
        * If `isPlaying` is true: Push to `queue`, broadcast `update-queue`.
    * **Song End:** When a client emits `song-ended`, the server checks if it's the host (or handles logic to avoid duplicates), then pops the next item from `queue` and broadcasts `play-song`.
    * **Skip:** Updates state and triggers the next song immediately.

**Client-Side Logic (`music.js`):**
* **Container Swapping:** * If `source === 'youtube'`: Hide Spotify container, Show YouTube IFrame.
    * If `source === 'spotify'`: Hide YouTube container, Show Spotify Player.
* **YouTube:** Use `YT.Player` API.
* **Spotify:** Use `Spotify Web Playback SDK`.
    * **Premium Check:** Handle the SDK error if the user is not Premium. Alert the user "Spotify Premium required".
    * **Token:** Since there is no Auth server yet, use a placeholder variable `const SPOTIFY_TOKEN = 'PASTE_TOKEN_HERE'` at the top of the file.

## 3. Implementation Guidelines

### Step 1: Server Setup (`server.js`)
* Initialize Express, Http, Socket.io, and PeerServer.
* Implement `rooms` object structure.
* Handle socket events: `join-room`, `disconnect`, `chat-message`, `add-song`, `song-ended`, `skip-song`.

### Step 2: UI Structure (`public/`)
* `index.html`: Clean landing page. Input for Name & Room Code.
* `room.html`: 
    * **Left:** Sidebar for Room Info & User List.
    * **Center:** Video Grid (Auto-resize for 1-4 videos).
    * **Right:** Chat & Music Panel (Tabbed or Split).
    * **Music Panel:** Search Input, Source Toggle (YT/Spotify), Queue List, Current Track info.

### Step 3: Client Logic (`public/js/`)
* **`rtc.js`**: Handle `new Peer()`, `call.answer()`, `peer.call()`, and stream handling.
* **`music.js`**: 
    * Initialize both players.
    * Listen for `play-song` socket event to switch context.
    * Send `song-ended` when media finishes.

## 4. Specific Rules for AI Generation
* **Do not use placeholders** for core logic. Write the actual logic for queue management.
* **Error Handling:** Ensure the app doesn't crash if a user leaves while a song is playing.
* **Styling:** Use CSS Grid for the video layout to ensure it looks good with 1, 2, 3, or 4 participants.

PasamCord/
├── .cursor/
│   └── rules/
│       └── pasamcord.mdc    <-- (Aşağıdaki kod buraya yapıştırılacak)
├── public/
│   ├── css/
│   │   └── style.css
│   ├── js/
│   │   ├── app.js           (Ana mantık: Socket.io & UI)
│   │   ├── rtc.js           (WebRTC: Görüntü/Ses/Ekran)
│   │   └── music.js         (Youtube API & Spotify SDK)
│   ├── index.html           (Giriş Sayfası)
│   └── room.html            (Sohbet Odası)
├── server.js                (Backend)
├── .env                     (API Keyleri buraya)
└── package.json